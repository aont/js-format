<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>JavaScript Minify / Format Tool</title>

    <script src="https://cdn.jsdelivr.net/npm/terser@5.44/dist/bundle.min.js"></script>

    <!-- Prettier (updated to latest stable) -->
    <script src="https://cdn.jsdelivr.net/npm/prettier@3.7/standalone.js"></script>
    <!-- Prettier plugins required for JavaScript formatting -->
    <script src="https://cdn.jsdelivr.net/npm/prettier@3.7/plugins/babel.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prettier@3.7/plugins/estree.js"></script>

    <style>
      :root {
        --bg: #f8fafc;
        --card: #ffffff;
        --surface: rgba(15, 23, 42, 0.04);
        --surface-strong: rgba(15, 23, 42, 0.08);
        --input-bg: rgba(148, 163, 184, 0.18);
        --status-bg: rgba(15, 23, 42, 0.06);
        --text: #0f172a;
        --muted: #475569;
        --border: rgba(15, 23, 42, 0.12);
        --primary: #2563eb;
        --danger: #dc2626;
        --radius: 14px;
        --shadow: 0 12px 30px rgba(15, 23, 42, 0.12);
        --accent-1: rgba(37, 99, 235, 0.12);
        --accent-2: rgba(234, 88, 12, 0.1);
      }
      body[data-theme='dark'] {
        --bg: #0b0f1a;
        --card: linear-gradient(180deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.02));
        --surface: rgba(0, 0, 0, 0.12);
        --surface-strong: rgba(255, 255, 255, 0.03);
        --input-bg: rgba(17, 24, 39, 0.55);
        --status-bg: rgba(0, 0, 0, 0.18);
        --text: #e5e7eb;
        --muted: #9ca3af;
        --border: rgba(255, 255, 255, 0.12);
        --primary: #60a5fa;
        --danger: #f87171;
        --shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
        --accent-1: rgba(96, 165, 250, 0.25);
        --accent-2: rgba(248, 113, 113, 0.18);
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, 'Noto Sans', 'Apple Color Emoji',
          'Segoe UI Emoji';
        background: radial-gradient(1000px 700px at 20% -10%, var(--accent-1), transparent 55%),
          radial-gradient(900px 600px at 90% 0%, var(--accent-2), transparent 50%), var(--bg);
        color: var(--text);
        line-height: 1.45;
      }
      .container {
        max-width: 980px;
        margin: 0 auto;
        padding: max(16px, env(safe-area-inset-top)) 16px max(16px, env(safe-area-inset-bottom));
      }
      header {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-bottom: 14px;
      }
      .headerRow {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }
      h1 {
        margin: 0;
        font-size: clamp(20px, 4.8vw, 28px);
        letter-spacing: 0.2px;
      }
      .subtitle {
        color: var(--muted);
        font-size: 13px;
      }

      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        overflow: hidden;
      }

      .toolbar {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        padding: 12px;
        align-items: center;
        border-bottom: 1px solid var(--border);
        background: var(--surface);
      }
      .btn {
        appearance: none;
        border: 1px solid var(--border);
        background: var(--surface);
        color: var(--text);
        padding: 12px 14px;
        border-radius: 12px;
        font-size: 14px;
        cursor: pointer;
        min-height: 44px; /* mobile tap target */
        display: inline-flex;
        align-items: center;
        gap: 8px;
        user-select: none;
        touch-action: manipulation;
      }
      .btn:active {
        transform: translateY(1px);
      }
      .btn.primary {
        border-color: rgba(96, 165, 250, 0.55);
        background: rgba(96, 165, 250, 0.18);
      }
      .btn.danger {
        border-color: rgba(248, 113, 113, 0.55);
        background: rgba(248, 113, 113, 0.14);
      }
      .btn.ghost {
        background: transparent;
      }
      .btn.small {
        min-height: 32px;
        padding: 8px 10px;
        font-size: 12px;
        border-radius: 999px;
        gap: 6px;
      }
      .btn:disabled {
        opacity: 0.55;
        cursor: not-allowed;
        transform: none;
      }

      .split {
        display: grid;
        grid-template-columns: 1fr;
        gap: 12px;
        padding: 12px;
      }
      @media (min-width: 860px) {
        .split {
          grid-template-columns: 1fr 1fr;
          align-items: start;
        }
      }

      .panel {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 12px;
        overflow: hidden;
      }
      .panelHead {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        border-bottom: 1px solid var(--border);
        background: var(--surface-strong);
      }
      .panelTitle {
        font-size: 13px;
        color: var(--muted);
        letter-spacing: 0.2px;
      }
      .panelActions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      textarea {
        width: 100%;
        min-height: 42vh;
        resize: vertical;
        padding: 12px;
        border: 0;
        outline: none;
        color: var(--text);
        background: var(--input-bg);
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
        font-size: 13px;
        line-height: 1.5;
      }
      textarea::placeholder {
        color: rgba(229, 231, 235, 0.5);
      }

      .footerRow {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
        justify-content: space-between;
        padding: 12px;
        border-top: 1px solid var(--border);
        background: var(--surface);
      }
      .bookmarkletBox {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
      }
      .link {
        color: var(--primary);
        text-decoration: none;
        border-bottom: 1px dashed rgba(96, 165, 250, 0.5);
        padding-bottom: 1px;
      }
      .hint {
        color: var(--muted);
        font-size: 12px;
      }

      .status {
        padding: 12px;
        border-top: 1px solid var(--border);
        background: var(--status-bg);
        color: var(--muted);
        font-size: 12px;
        white-space: pre-wrap;
        word-break: break-word;
      }
      .status.error {
        color: var(--danger);
      }

      /* Make inputs feel better on mobile */
      @media (max-width: 520px) {
        textarea {
          min-height: 34vh;
          font-size: 14px;
        }
        .btn {
          width: 100%;
          justify-content: center;
        }
        .panelActions .btn {
          width: auto;
        }
        .toolbar .btn {
          flex: 1;
          justify-content: center;
        }
      }
    </style>
  </head>

  <body>
    <div class="container">
      <header>
        <div class="headerRow">
          <div>
            <h1>JavaScript Minify / Format Tool</h1>
            <div class="subtitle">Mobile-friendly UI with large tap targets. Paste code, minify, format, and copy easily.</div>
          </div>
          <button id="themeToggle" class="btn ghost small" type="button" aria-pressed="false" title="Switch to dark background">
            <span class="themeIcon" aria-hidden="true">‚òÄÔ∏è</span>
            <span class="themeLabel">White</span>
          </button>
        </div>
      </header>

      <div class="card" role="application" aria-label="JavaScript Minify and Format Tool">
        <div class="toolbar">
          <button id="btnMinify" class="btn primary" type="button" title="Minify input into the output box">Minify ‚Üì</button>
          <button id="btnFormat" class="btn primary" type="button" title="Format output into the input box">Format ‚Üë</button>
          <button id="btnSwap" class="btn" type="button" title="Swap input and output">Swap ‚áÑ</button>
          <button id="btnClear" class="btn danger" type="button" title="Clear both boxes">Clear</button>
        </div>

        <div class="split">
          <section class="panel" aria-label="Original code panel">
            <div class="panelHead">
              <div class="panelTitle">Input (original / formatted)</div>
              <div class="panelActions">
                <button id="btnPasteIn" class="btn" type="button" title="Paste from clipboard into Input">Paste</button>
                <button id="btnCopyIn" class="btn" type="button" title="Copy Input to clipboard">Copy</button>
              </div>
            </div>
            <textarea id="taInput" placeholder="Paste JavaScript here..."></textarea>
          </section>

          <section class="panel" aria-label="Minified code panel">
            <div class="panelHead">
              <div class="panelTitle">Output (minified)</div>
              <div class="panelActions">
                <button id="btnCopyOut" class="btn" type="button" title="Copy Output to clipboard">Copy</button>
                <button id="btnSelectOut" class="btn" type="button" title="Select all in Output">Select</button>
              </div>
            </div>
            <textarea id="taOutput" placeholder="Minified code will appear here..."></textarea>
          </section>
        </div>

        <div class="footerRow">
          <div class="bookmarkletBox">
            <div class="hint">Bookmarklet link:</div>
            <a id="bookmarklet" class="link" href="about:blank" draggable="true" aria-label="Bookmarklet link">bookmarklet</a>
          </div>
          <div class="hint" id="liveHint">Tip: on iOS/Safari, long-press the link to add it to bookmarks.</div>
        </div>

        <div id="status" class="status" aria-live="polite"></div>
      </div>
    </div>

    <script>
      window.addEventListener('load', () => {
        const jsUri = 'javascript:';
        const $ = (id) => document.getElementById(id);
    
        const taInput = $('taInput');
        const taOutput = $('taOutput');
        const status = $('status');
        const bookmarklet = $('bookmarklet');
        const themeToggle = $('themeToggle');
    
        const btnMinify = $('btnMinify');
        const btnFormat = $('btnFormat');
        const btnSwap = $('btnSwap');
        const btnClear = $('btnClear');
    
        const btnPasteIn = $('btnPasteIn');
        const btnCopyIn = $('btnCopyIn');
        const btnCopyOut = $('btnCopyOut');
        const btnSelectOut = $('btnSelectOut');

        const THEME_KEY = 'js-format-theme';
        const themes = {
          light: {
            label: 'White',
            icon: '‚òÄÔ∏è',
            title: 'Switch to dark background',
            pressed: 'false',
          },
          dark: {
            label: 'Black',
            icon: 'üåô',
            title: 'Switch to white background',
            pressed: 'true',
          },
        };

        // ---- Debug logger ----
        const DEBUG = true;
        const log = (...args) => DEBUG && console.log('[Tool]', ...args);
        const warn = (...args) => DEBUG && console.warn('[Tool]', ...args);
        const err = (...args) => console.error('[Tool]', ...args);
    
        // ---- Global error hooks (very useful on mobile Safari) ----
        window.addEventListener('error', (e) => {
          err('window error:', e.message, e.error || e);
          setStatus(`Runtime error: ${e.message}`, true);
        });
        window.addEventListener('unhandledrejection', (e) => {
          err('unhandledrejection:', e.reason);
          const msg =
            e.reason && (e.reason.stack || e.reason.message)
              ? e.reason.stack || e.reason.message
              : String(e.reason);
          setStatus(`Unhandled rejection: ${msg}`, true);
        });
    
        function setStatus(message, isError = false) {
          status.classList.toggle('error', !!isError);
          status.textContent = message || '';
        }

        function applyTheme(theme) {
          const nextTheme = theme === 'dark' ? 'dark' : 'light';
          document.body.dataset.theme = nextTheme === 'dark' ? 'dark' : '';
          const themeMeta = themes[nextTheme];
          themeToggle.setAttribute('aria-pressed', themeMeta.pressed);
          themeToggle.title = themeMeta.title;
          themeToggle.querySelector('.themeIcon').textContent = themeMeta.icon;
          themeToggle.querySelector('.themeLabel').textContent = themeMeta.label;
          localStorage.setItem(THEME_KEY, nextTheme);
        }
    
        function updateButtons() {
          btnMinify.disabled = !taInput.value.trim();
          btnFormat.disabled = !taOutput.value.trim();
          btnSwap.disabled = !taInput.value.trim() && !taOutput.value.trim();
          btnClear.disabled = !taInput.value.trim() && !taOutput.value.trim();
          btnCopyIn.disabled = !taInput.value.trim();
          btnCopyOut.disabled = !taOutput.value.trim();
          btnSelectOut.disabled = !taOutput.value.trim();
        }
    
        function setBookmarkletFromCode(code) {
          if (!code || !code.trim()) {
            bookmarklet.href = 'about:blank';
            return;
          }
          bookmarklet.href = jsUri + code.replaceAll("%", "%25").replaceAll("\"", "%22");
        }
    
        async function safeClipboardWrite(text) {
          try {
            await navigator.clipboard.writeText(text);
            return true;
          } catch (e) {
            warn('clipboard write failed:', e);
            return false;
          }
        }
    
        async function safeClipboardRead() {
          try {
            return await navigator.clipboard.readText();
          } catch (e) {
            warn('clipboard read failed:', e);
            return '';
          }
        }
    
        function normalizeBookmarkletInput(code) {
          let c = (code || '').trim();
          if (c.startsWith(jsUri)) {
            c = c.slice(jsUri.length);
            try {
              c = decodeURIComponent(c);
            } catch (_) {
              // not URI-encoded
            }
          }
          return c;
        }
    
        // ---- Dependency diagnostics ----
        function dumpEnv() {
          log('DOM loaded');
          log('Terser:', typeof window.Terser, window.Terser);
          log('prettier:', typeof window.prettier, window.prettier);
          log('prettierPlugins:', typeof window.prettierPlugins, window.prettierPlugins);
    
          if (window.prettier) {
            log('prettier.version:', window.prettier.version);
            log('prettier.format is function:', typeof window.prettier.format === 'function');
          }
    
          if (window.prettierPlugins) {
            // typical keys: babel / estree (and more if you load others)
            log('prettierPlugins keys:', Object.keys(window.prettierPlugins));
          } else {
            warn('prettierPlugins is missing. Plugin scripts may not be loaded or blocked.');
          }
        }
        dumpEnv();
    
        async function doMinify() {
          log('doMinify clicked. input length:', taInput.value.length);
    
          try {
            setStatus('');
            const inputText = taInput.value;
            if (!inputText.trim()) return;
    
            if (!window.Terser || typeof window.Terser.minify !== 'function') {
              throw new Error('Terser is not available. Check the terser script tag / network.');
            }
    
            btnMinify.disabled = true;
    
            const result = await window.Terser.minify(inputText, {
              mangle: false,
              compress: { inline: false, sequences: false, join_vars: false },
            });
    
            log('Terser result:', result);
    
            if (result.error) throw result.error;
    
            taOutput.value = result.code || '';
            setBookmarkletFromCode(result.code || '');
            setStatus('Minified successfully.');
            log('minify done. output length:', taOutput.value.length);
          } catch (error) {
            err('doMinify error:', error);
            const msg =
              error && (error.stack || error.message) ? error.stack || error.message : String(error);
            setStatus(msg, true);
          } finally {
            updateButtons();
          }
        }
    
        async function doFormat() {
          log('doFormat clicked. output length:', taOutput.value.length);
    
          try {
            setStatus('');
            let code = taOutput.value;
            if (!code.trim()) return;
    
            btnFormat.disabled = true;
            code = normalizeBookmarkletInput(code);
    
            if (!window.prettier || typeof window.prettier.format !== 'function') {
              throw new Error('prettier.format is not available. Check the prettier script tag / network.');
            }
            if (!window.prettierPlugins) {
              throw new Error('prettierPlugins is missing. Ensure plugins/babel.js and plugins/estree.js are loaded.');
            }
    
            log('format input (first 200 chars):', code.slice(0, 200));
    
            // Prettier v3+ expects plugins. `prettierPlugins` is provided by plugin scripts.
            const formatted = await window.prettier.format(code, {
              parser: 'babel',
              semi: true,
              singleQuote: true,
              plugins: window.prettierPlugins,
            });
    
            log('format output (first 200 chars):', formatted.slice(0, 200));
    
            taInput.value = formatted;
            setStatus('Formatted successfully.');
          } catch (error) {
            err('doFormat error:', error);
            const msg =
              error && (error.stack || error.message) ? error.stack || error.message : String(error);
            setStatus(msg, true);
          } finally {
            updateButtons();
          }
        }
    
        function doSwap() {
          log('doSwap clicked');
          const a = taInput.value;
          taInput.value = taOutput.value;
          taOutput.value = a;
          setBookmarkletFromCode(taOutput.value);
          setStatus('Swapped input and output.');
          updateButtons();
        }
    
        function doClear() {
          log('doClear clicked');
          taInput.value = '';
          taOutput.value = '';
          setBookmarkletFromCode('');
          setStatus('');
          updateButtons();
        }
    
        btnMinify.addEventListener('click', doMinify);
        btnFormat.addEventListener('click', doFormat);
        btnSwap.addEventListener('click', doSwap);
        btnClear.addEventListener('click', doClear);
        themeToggle.addEventListener('click', () => {
          const currentTheme = document.body.dataset.theme === 'dark' ? 'dark' : 'light';
          applyTheme(currentTheme === 'dark' ? 'light' : 'dark');
        });
    
        btnSelectOut.addEventListener('click', () => {
          log('btnSelectOut clicked');
          taOutput.focus();
          taOutput.select();
          setStatus('Output selected. Copy it from the system menu if needed.');
          updateButtons();
        });
    
        btnCopyIn.addEventListener('click', async () => {
          log('btnCopyIn clicked. len:', taInput.value.length);
          const ok = await safeClipboardWrite(taInput.value);
          setStatus(ok ? 'Input copied to clipboard.' : 'Could not access clipboard. Select and copy manually.', !ok);
        });
    
        btnCopyOut.addEventListener('click', async () => {
          log('btnCopyOut clicked. len:', taOutput.value.length);
          const ok = await safeClipboardWrite(taOutput.value);
          setStatus(ok ? 'Output copied to clipboard.' : 'Could not access clipboard. Select and copy manually.', !ok);
        });
    
        btnPasteIn.addEventListener('click', async () => {
          log('btnPasteIn clicked');
          const text = await safeClipboardRead();
          if (!text) {
            setStatus('Clipboard read failed (browser permissions). Paste manually into the Input box.', true);
            return;
          }
          taInput.value = text;
          setStatus('Pasted into Input.');
          updateButtons();
        });
    
        // Live updates
        taInput.addEventListener('input', () => {
          setStatus('');
          updateButtons();
        });
        taOutput.addEventListener('input', () => {
          setStatus('');
          setBookmarkletFromCode(normalizeBookmarkletInput(taOutput.value));
          updateButtons();
        });
    
        setStatus('Ready.');
        updateButtons();
        applyTheme(localStorage.getItem(THEME_KEY) || 'light');
        log('Ready.');
      });
    </script>
    
  </body>
</html>
